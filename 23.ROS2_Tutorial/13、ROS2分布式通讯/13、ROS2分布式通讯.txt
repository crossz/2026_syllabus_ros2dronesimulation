13 、 ROS2 分布式通讯  
1 、概念  
多机通讯即分布式通信是指可以通过网络在不同主机之间实现数据交互的一种通信策略。
ROS2 本身是一个分布式通信框架，可以很方便的实现不同设备之间的通信， ROS2 所基于的中间件是
DDS ，当处于同一网络中时，通过 DDS 的域 ID 机制 (ROS_DOMAIN_ID) 可以实现分布式通信，大致流程
是：在启动节点之前，可以设置域 ID 的值，不同节点如果域 ID 相同，那么可以自由发现并通信，反之，
如果域 ID 值不同，则不能实现。默认情况下，所有节点启动时所使用的域 ID 为 0 ，换言之，只要保证在同
一网络，你不需要做任何配置，不同 ROS2 设备上的不同节点即可实现分布式通信。
分布式通信的应用场景是较为广泛的，无人车编队、无人机编队、远程控制等等，  这些数据的交互都依
赖于分布式通信。
 
2 、实现  
2.1 、默认实现  
只需要将主机和从机【可以有多个】处于同一个网络中，就已经实现了分布式通讯。比如主机和从机连
接同一个 WiFi 或者同一个路由器。
Windows 中虚拟机设置网络为【桥接模式】就和主机处于同一个网络了。
 
测试：
这里假设我们有两台主机 A 和 B ，可以是任何形式能连接网络的主机例如：虚拟机、树莓派、
jetson 、 x86/ARM 主机、卡片主板，只需要安装相同版本的 ros2 环境即可
1 、A 主机执行：
这里演示的是小车处于 docker 中， docker 使用的网络模式是 host 模式， host 模式简单来说就是和小车共
用一个网络，所以跟在小车上执行没有区别。
2 、B 主机执行：
若显示如下：主机端发布的话题从机端能及时订阅到，表示已经实现了多机通讯ros2 run demo_nodes_py talker
ros2 run demo_nodes_py listener

 
2.2 、分布式网络分组  
假设你现在所处的网络中还有其它的机器人在使用，为了不受其它机器人的干扰，你还可以给你的机器
人设置一个分组。
ROS2 提供了一个 DOMAIN 的机制，就类似分组一样，处于同一个 DOMAIN 中的计算机才能通信，我们
可以在主机端【小车】和从机端【虚拟机】的 .bashrc 中加入这样一句配置，即可将两者分配到一个小组
中：
如果主机端【小车】和从机端【虚拟机】分配的 ID 不同，则两者无法实现通信，达到分组的目的。
 
2.2.1 案例 1  
1 、主机端【小车】执行：
这里演示的是小车处于 docker 中， docker 使用的网络模式是 host 模式， host 模式简单来说就是和小车共
用一个网络，所以跟在小车上执行没有区别。
2 、同时从机端【虚拟机】执行：
若显示如下：主机端发布的话题从机端能及时订阅到，表示已经实现了分组的多机通讯  $ export ROS_DOMAIN_ID=<your_domain_id>
echo "export ROS_DOMAIN_ID=6" >> ~/.bashrc  # 这里的 6 是 ROS_DOMAIN_ID, 不一定要用 6 ，
符合ROS_DOMAIN_ID 的规则即可
source ~/.bashrc
ros2 run demo_nodes_py talker
echo "export ROS_DOMAIN_ID=6" >> ~/.bashrc  # 这里和主机端的值保持一致
source ~/.bashrc
ros2 run demo_nodes_py listener

 
2.2.2 案例 2  
通过分布式通信控制小海龟运动
主机 A 运行指令
主机 B 运行指令
 
3 、注意  
在设置 ROS_DOMAIN_ID 的值时并不是随意的，也是有一定约束的：
1. 建议 ROS_DOMAIN_ID 的取值在 [0,101] 之间，包含 0 和 101 ；
2. 每个域 ID 内的节点总数是有限制的，需要小于等于 120 个；
3. 如果域 ID 为 101 ，那么该域的节点总数需要小于等于 54 个。
 
4 、DDS 域  ID 值的计算规则 ( 进阶知识 )  
域ID 值的相关计算规则如下：
1. DDS 是基于 TCP/IP 或 UDP/IP 网络通信协议的，网络通信时需要指定端口号，端口号由 2 个字节的无
符号整数表示，其取值范围在 [0,65535] 之间；
2. 端口号的分配也是有其规则的，并非可以任意使用的，根据 DDS 协议规定以 7400 作为起始端口，也
即可用端口为 [7400,65535] ，又已知按照 DDS 协议默认情况下，每个域 ID 占用 250 个端口，那么域
ID 的个数为： (65535-7400)/250 = 232( 个 ) ，对应的其取值范围为 [0,231] ；
3. 操作系统还会设置一些预留端口，在 DDS 中使用端口时，还需要避开这些预留端口，以免使用中产
生冲突，不同的操作系统预留端口又有所差异，其最终结果是，在 Linux 下，可用的域 ID 为 [0,101]
与[215-231] ，在 Windows 和 Mac 中可用的域 ID 为 [0,166] ，综上，为了兼容多平台，建议域 ID 在
[0,101] 范围内取值。ros2 run turtlesim turtlesim_node
ros2 run turtlesim turtle_teleop_key

4. 每个域 ID 默认占用 250 个端口，且每个 ROS2 节点需要占用两个端口，另外，按照 DDS 协议每个域 ID
的端口段内，第 1 、 2 个端口是 Discovery Multicast 端口与 User Multicast 端口，从第 11 、 12 个端口
开始是域内第一个节点的 Discovery Unicast 端口与 User Unicast ，后续节点所占用端口依次顺延，
那么一个域 ID 中的最大节点个数为： (250-10)/2 = 120( 个 ) ；
5. 特殊情况：域 ID 值为 101 时，其后半段端口属于操作系统的预留端口，其节点最大个数为 54 个。
上述计算规则了解即可。